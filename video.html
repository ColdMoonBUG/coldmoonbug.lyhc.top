<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>冷月的小视频</title>
    <link rel="apple-touch-icon" sizes="57x57" href="logoicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="logoicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="logoicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="logoicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="logoicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="logoicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="logoicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="logoicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="logoicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="logoicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="logoicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="logoicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="logoicon/favicon-16x16.png">
    <link rel="manifest" href="logoicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <style>
        /* 全局样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }

        /* 视频容器样式 */
        .video-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            min-height: 100vh;
        }

        /* 固定视频竖屏比例样式 */
        video {
            width: 100%;
            max-width: 360px;
            /* 根据实际需要设定最大宽度 */
            aspect-ratio: 9 / 16;
            /* 固定为 9:16 比例，竖屏 */
            margin-bottom: 20px;
            background: black;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            object-fit: cover;
            /* 保持内容填充视频框 */
            transition: transform 0.3s ease;
        }

        /* 当前播放视频的样式 */
        video.current {
            transform: scale(1.05);
        }

        /* 加载指示器样式 */
        .loading {
            text-align: center;
            font-size: 1.2em;
            color: #555;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="video-container" id="videoContainer">
        <div class="loading" id="loading">正在加载视频...</div>
    </div>

    <script>
        (function () {
    const videoContainer = document.getElementById('videoContainer');
    const loadingIndicator = document.getElementById('loading');
    let currentVideoIndex = 0;
    const initialLoadCount = 10;
    const maxVideosOnScreen = 15;
    let loading = false;
    const loadedVideos = new Set();  // 用来缓存已加载的视频URL

    // 定义多个视频接口的 URL 列表
    const apiUrls = [
        { url: 'https://v2.api-m.com/api/meinv', key: 'data' },  // JSON中 data 字段为视频地址
        { url: 'https://api.lolimi.cn/API/xjj/xjj.php', key: 'direct' }, 
        { url: 'http://api.yujn.cn/api/xjj.php?type=json', key: 'data' },
        { url: 'http://api.yujn.cn/api/zzxjj.php?type=json', key: 'data' },
        { url: 'https://api.pearktrue.cn/api/random/xjj/?type=json', key: 'video' },
        { url: 'https://rapid-sunset-f444.2991742315.workers.dev/?url=http://api.yujn.cn/api/kuaimao.php?type=json', key: 'video' },
        { url: 'http://api.yujn.cn/api/COS.php?type=json', key: 'data' },
        { url: 'http://api.yujn.cn/api/qingchun.php?type=json', key: 'data' },
        { url: 'http://api.yujn.cn/api/nvgao.php?type=json', key: 'data' },
        { url: 'http://api.yujn.cn/api/ksbianzhuang.php?type=json', key: 'data' },
        { url: 'http://api.yujn.cn/api/luoli.php?type=json', key: 'data' },
        { url: 'http://api.yujn.cn/api/tianmei.php?type=json', key: 'data' },
        { url: 'http://api.yujn.cn/api/jksp.php?type=json', key: 'data' },
        { url: 'http://api.yujn.cn/api/yuzu.php?type=json', key: 'data' },
        { url: 'http://api.yujn.cn/api/rewu.php?type=json', key: 'data' },
        { url: 'http://api.yujn.cn/api/ksxjjsp.php?', key: 'direct' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        loadInitialVideos(initialLoadCount);
        initializeIntersectionObserver();
    });

    window.addEventListener('scroll', debounce(() => {
        if (!loading && isNearBottom()) {
            loadNextVideo();
        }
    }, 200));

    async function loadInitialVideos(count) {
        loading = true;
        loadingIndicator.style.display = 'block';

        try {
            for (let i = 0; i < count; i++) {
                const videoUrl = await fetchNewVideo();
                if (videoUrl) {
                    await showVideo(videoUrl);
                    currentVideoIndex++;
                }
            }
        } catch (error) {
            console.error('初始加载视频失败:', error);
            showError('无法加载视频。');
        }

        loading = false;
        loadingIndicator.style.display = 'none';
    }

    async function loadNextVideo() {
        if (loading) return;
        loading = true;
        loadingIndicator.style.display = 'block';

        try {
            const videoUrl = await fetchNewVideo();

            // 如果已经加载过该视频，则跳过
            if (loadedVideos.has(videoUrl)) {
                loading = false;
                loadingIndicator.style.display = 'none';
                return;
            }

            // 将视频 URL 缓存
            loadedVideos.add(videoUrl);

            await showVideo(videoUrl);
            currentVideoIndex++;

            // 控制屏幕上的最大视频数量
            if (videoContainer.querySelectorAll('video').length > maxVideosOnScreen) {
                clearOldestVideo();
            }
        } catch (error) {
            console.error('获取视频失败:', error);
            showError('无法加载视频。');
        }

        loading = false;
        loadingIndicator.style.display = 'none';
    }

    async function fetchNewVideo() {
        const maxRetries = 5; // 增加最大重试次数为 5
        let attempts = 0;

        while (attempts < maxRetries) {
            try {
                // 随机选择一个接口
                const randomApi = apiUrls[Math.floor(Math.random() * apiUrls.length)];
                const response = await fetch(randomApi.url, {
                    method: 'GET',
                    redirect: 'follow',
                });
                let videoUrl;
                if (randomApi.key === 'direct') {
                    // 对于直接返回视频地址的接口，直接获取重定向后的最终 URL
                    videoUrl = response.url;
                } else {
                    // 对于返回 JSON 的接口，解析指定字段获取视频地址
                    const result = await response.json();
                    videoUrl = result[randomApi.key];
                    console.log("已加载" + videoUrl);
                }

                if (isValidUrl(videoUrl)) {
                    return videoUrl;
                } else {
                    console.error('无效的视频 URL');
                }
            } catch (error) {
                console.error(`接口请求失败: 第${attempts + 1}次重试`, error);
            }
            attempts++;
        }

        throw new Error('所有接口请求失败');
    }

    function isValidUrl(url) {
        return typeof url === 'string' && url.startsWith('http');
    }

    function showError(message) {
        loadingIndicator.textContent = message;
    }

    async function showVideo(videoUrl) {
        return new Promise((resolve, reject) => {
            let videoElement = document.createElement('video');
            videoElement.src = videoUrl;
            videoElement.controls = true;
            videoElement.autoplay = false;
            videoElement.playsInline = true;
            videoElement.preload = 'auto';  // 设置为 'auto' 来启用缓存
            videoElement.load();  // 预加载视频

            videoContainer.appendChild(videoElement);

            videoElement.addEventListener('loadedmetadata', resolve);
            videoElement.addEventListener('error', (e) => {
                console.error('视频元素加载错误:', e);
                reject(new Error('视频元素加载错误'));
            });
        });
    }

    function clearOldestVideo() {
        const firstVideo = videoContainer.querySelector('video');
        if (firstVideo) {
            firstVideo.pause();
            videoContainer.removeChild(firstVideo);
        }
    }

    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function isNearBottom() {
        return window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 200;
    }

    function initializeIntersectionObserver() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadNextVideo();
                }
            });
        }, {
            root: null,
            rootMargin: '0px',
            threshold: 0.25
        });

        observer.observe(document.querySelector('#loading'));
    }
})();

    </script>
</body>

</html>