<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>冷月的小视频</title>
    <link rel="apple-touch-icon" sizes="57x57" href="logoicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="logoicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="logoicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="logoicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="logoicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="logoicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="logoicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="logoicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="logoicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="logoicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="logoicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="logoicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="logoicon/favicon-16x16.png">
    <link rel="manifest" href="logoicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <style>
        /* 全局样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }

        /* 视频容器样式 */
        .video-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            min-height: 100vh;
        }

        /* 固定视频竖屏比例样式 */
        video {
            width: 100%;
            max-width: 360px;
            /* 根据实际需要设定最大宽度 */
            aspect-ratio: 9 / 16;
            /* 固定为 9:16 比例，竖屏 */
            margin-bottom: 20px;
            background: black;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            object-fit: cover;
            /* 保持内容填充视频框 */
            transition: transform 0.3s ease;
        }

        /* 当前播放视频的样式 */
        video.current {
            transform: scale(1.05);
        }

        /* 加载指示器样式 */
        .loading {
            text-align: center;
            font-size: 1.2em;
            color: #555;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="video-container" id="videoContainer">
        <div class="loading" id="loading">正在加载视频...</div>
    </div>

    <script>
        (function () {
            const videoContainer = document.getElementById('videoContainer');
            const loadingIndicator = document.getElementById('loading');
            let currentVideoIndex = 0;
            const initialLoadCount = 5;
            const maxVideosOnScreen = 10;
            let loading = false;
            let videoHistory = [];

            // 定义多个视频接口的 URL 列表
            const apiUrls = [
                { url: 'https://v2.api-m.com/api/meinv', key: 'data' },  // JSON中 data 字段为视频地址
                { url: 'https://api.lolimi.cn/API/xjj/xjj.php', key: 'direct' }, // 无需解析，直接返回视频地址
                { url: 'http://api.yujn.cn/api/xjj.php?type=video', key: 'direct' },
                { url: 'http://api.yujn.cn/api/zzxjj.php?type=video', key: 'direct' },// 无需解析，直接返回视频地址
                { url: 'https://api.pearktrue.cn/api/random/xjj/?type=json', key: 'video' },
                { url: 'https://api.yujn.cn/api/kuaimao.php', key: 'video' }// JSON中 video 字段为视频地址
            ];

            document.addEventListener('DOMContentLoaded', () => {
                loadInitialVideos(initialLoadCount);
                initializeIntersectionObserver();
            });

            window.addEventListener('scroll', debounce(() => {
                if (!loading && isNearBottom()) {
                    loadNextVideo();
                }
            }, 200));

            async function loadInitialVideos(count) {
                loading = true;
                loadingIndicator.style.display = 'block';

                try {
                    for (let i = 0; i < count; i++) {
                        const videoUrl = await fetchNewVideo();
                        if (videoUrl) {
                            await showVideo(videoUrl);
                            currentVideoIndex++;
                        }
                    }
                } catch (error) {
                    console.error('初始加载视频失败:', error);
                    showError('无法加载视频。');
                }

                loading = false;
                loadingIndicator.style.display = 'none';
            }

            async function loadNextVideo() {
                if (loading) return;
                loading = true;
                loadingIndicator.style.display = 'block';

                try {
                    const videoUrl = await fetchNewVideo();
                    if (videoUrl) {
                        await showVideo(videoUrl);
                        currentVideoIndex++;

                        if (videoContainer.querySelectorAll('video').length > maxVideosOnScreen) {
                            clearOldestVideo();
                        }
                    }
                } catch (error) {
                    console.error('获取视频失败:', error);
                    showError('无法加载视频。');
                }

                loading = false;
                loadingIndicator.style.display = 'none';
            }

            async function fetchNewVideo() {
                const maxRetries = 3; // 最大重试次数
                let attempts = 0;

                while (attempts < maxRetries) {
                    try {
                        // 随机选择一个接口
                        const randomApi = apiUrls[Math.floor(Math.random() * apiUrls.length)];
                        const response = await fetch(randomApi.url, {
                            method: 'GET',
                            redirect: 'follow',
                            headers: {
                                'Proxy-Authorization': 'Basic ' + btoa('icloc:rncasktxieobbcaf2TrmG7lSHuiyVO4IwCvjdZW8')
                            }
                        });

                        // 检查响应状态码
                        if (response.ok) {
                            let videoUrl;

                            if (randomApi.key === 'direct') {
                                // 对于直接返回视频地址的接口，直接获取重定向后的最终 URL
                                videoUrl = response.url;
                            } else {
                                // 对于返回 JSON 的接口，解析指定字段获取视频地址
                                const result = await response.json();
                                videoUrl = result[randomApi.key];
                            }

                            // 检查并返回有效的 URL
                            if (isValidUrl(videoUrl)) {
                                return videoUrl;
                            } else {
                                console.warn(`无效的视频 URL：${videoUrl}`);
                            }
                        } else {
                            console.warn(`请求失败，状态码：${response.status}`);
                        }
                    } catch (error) {
                        console.error('接口请求失败:', error);
                    }
                    attempts++;
                }

                throw new Error('所有接口请求失败');
            }

            // URL 验证函数
            function isValidUrl(url) {
                try {
                    const parsedUrl = new URL(url);
                    return parsedUrl.protocol === 'http:' || parsedUrl.protocol === 'https:';
                } catch (_) {
                    return false;
                }
            }





            async function showVideo(videoUrl) {
                return new Promise((resolve, reject) => {
                    let videoElement = document.createElement('video');
                    videoElement.src = videoUrl;
                    videoElement.controls = true;
                    videoElement.autoplay = false;
                    videoElement.playsInline = true;
                    videoElement.preload = 'metadata';

                    videoContainer.appendChild(videoElement);

                    videoElement.addEventListener('loadedmetadata', resolve);
                    videoElement.addEventListener('error', (e) => {
                        console.error('视频元素加载错误:', e);
                        reject(new Error('视频元素加载错误'));
                    });
                });
            }

            function clearOldestVideo() {
                const firstVideo = videoContainer.querySelector('video');
                if (firstVideo) {
                    firstVideo.pause();
                    videoContainer.removeChild(firstVideo);
                }
            }

            function initializeIntersectionObserver() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const video = entry.target;
                        if (entry.isIntersecting) {
                            video.play().catch(error => {
                                console.error('视频播放失败:', error);
                            });
                            video.classList.add('current');
                        } else {
                            video.pause();
                            video.classList.remove('current');
                        }
                    });
                }, { threshold: 0.5 });

                const config = { childList: true, subtree: true };
                const containerObserver = new MutationObserver((mutationsList) => {
                    for (let mutation of mutationsList) {
                        if (mutation.type === 'childList') {
                            mutation.addedNodes.forEach(node => {
                                if (node.tagName === 'VIDEO') {
                                    observer.observe(node);
                                }
                            });
                        }
                    }
                });

                containerObserver.observe(videoContainer, config);
            }

            function debounce(func, delay) {
                let debounceTimer;
                return function () {
                    const context = this;
                    const args = arguments;
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func.apply(context, args), delay);
                };
            }

            function showError(message) {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.textContent = message;
                videoContainer.appendChild(errorMsg);

                setTimeout(() => {
                    if (errorMsg.parentNode) {
                        errorMsg.parentNode.removeChild(errorMsg);
                    }
                }, 3000);
            }

            function isNearBottom() {
                const scrollY = window.scrollY;
                const windowHeight = window.innerHeight;
                const documentHeight = document.body.offsetHeight;
                return scrollY + windowHeight >= documentHeight - 100;
            }
        })();
    </script>
</body>

</html>